--WEB-72664-RC START
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TransactionId',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ParentCompany',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductSegment',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ApplicationNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FirstHolderRelation',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FirstHolderRecordIdentifier',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FirstHolderSourceSystemName',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FirstHolderSourceSystemCustomerCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountOpeningDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountStatusEffectiveDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountStatusDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountStatusReasonCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductAccountReasonCodeDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='Remarks',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='OldProductAccountNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='Channel',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IntermediaryCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IntroducerEmployeeCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RelatedPartyCount',@ColumnDataType='int'  --------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='Currency',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProductApplicationDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ApplicationSignedDate',@ColumnDataType='datetime'  --------------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AsOfDate',@ColumnDataType='datetime'------------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='BankCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='MICRCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='BankName',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='BankBranchName',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AccountNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AccountType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IFSCCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='Tags',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RiskCommencementDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FirstPremiumReceiptDateString',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='LoginDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='UnderwritingDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='BranchReceiptDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='InsurancePurpose',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SumAssured',@ColumnDataType='decimal'---------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='GrossAnnualPremiumwithTax',@ColumnDataType='decimal'-----------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='GrossAnnualPremiumwithoutTax',@ColumnDataType='decimal'----------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ModalPremium',@ColumnDataType='decimal'--------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PolicyTerm',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PayTerm',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TransactionFrequency',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PolicyEndDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SanctionDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DisbursementDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SanctionedAmount',@ColumnDataType='decimal'  -----------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='NatureofCredit',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RateofInterest',@ColumnDataType='decimal'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='LendingArrangement',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TotalOutstandingAmount',@ColumnDataType='decimal'--------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AmountOverdue',@ColumnDataType='decimal' --------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DaysPastDue',@ColumnDataType='int' ----------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SecurityCount',@ColumnDataType='int' ----------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FinalEMIDate',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TenureInMonths',@ColumnDataType='int' ------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='EMIAmount',@ColumnDataType='decimal' ---------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='BorrowerDetails',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SecurityDetails',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IsDefaulted',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DateOfDefault',@ColumnDataType='date'   ----------Changed with name
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DefaultAmount',@ColumnDataType='decimal' ---------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AmountOfLastPayment',@ColumnDataType='decimal'  --------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DateofLastRepayment',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DateofFilingofSuit',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DebtSubtype',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='FundedType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CreditorBusinessUnit',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='InterestOutstanding',@ColumnDataType='decimal' ----------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='OtherChargesOutstanding',@ColumnDataType='decimal' ------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DrawingPower',@ColumnDataType='decimal' -------------------
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CreditorRMEmail',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='DefaultRemarks',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ModuleApplicable',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PolicyType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RMType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RMCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentCKYCAddressType',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PlotnoSurveynoHouseFlatno',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressCountry',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressPinCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressLine1',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressLine2',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressLine3',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressDistrict',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressCity',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressState',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PermanentAddressProof',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressCountry',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressPinCode',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressLine1',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressLine2',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressLine3',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressDistrict',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressCity',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressState',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CorrespondenceAddressProof',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PersonalMobileISD',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PersonalMobileNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='PersonalEmail',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='AccountSegment',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ProcessingResponseStatus',@ColumnDataType='varchar'  ---------Change Name
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='UniqueRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='UniqueRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='UniqueRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RejectedFields',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CKYCStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CKYCRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CKYCRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CKYCRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TMStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TMRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TMRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='TMRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ScreeningStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ScreeningRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ScreeningRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='ScreeningRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RiskRatingStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RiskRatingRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RiskRatingRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RiskRatingRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IULStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IULRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IURejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='IURejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CersaiStatus',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CersaiRejectionCount',@ColumnDataType='int'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CersaiRejectionCodes',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='CersaiRejectionDescription',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='SanctionReferenceNumber',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RBIAssetClassification',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='RBISMACategory',@ColumnDataType='varchar'
GO
GO
EXEC dbo.RefReportColumn_Insert @Code='R570',@ReportColumnName='LoanSecured',@ColumnDataType='varchar'
GO
--WEB-72664-RC END
update ref
set ref.DaysSpanRange =null
from refreport ref where code = 'R570'
select * from refreportcolumn where refreportid = 499
select code,* from RefEntityType where RefParentCompanyId =31

  alter PROCEDURE [dbo].[GetCoreClientHistory_R570]    
(    
 @FromDate DATETIME,    
 @ToDate DATETIME,     
 @ProcessingStatus INT  = NULL,    
 @CurrentEntityType  VARCHAR(500) = NULL    
)    
AS    
BEGIN    
   DECLARE @InternalFromDate DATETIME, @InternalToDate DATETIME, @InternalProcessingStatus INT, @ParentCompanyId INT     
           
 SET @InternalFromDate = dbo.GetDateWithoutTime(@FromDate)                  
 SET @InternalToDate =   DATEADD(SECOND,-1,DATEADD(DAY,1,dbo.GetDateWithoutTime(@ToDate)))         
 SET @InternalProcessingStatus = @ProcessingStatus     
 SELECT @ParentCompanyId = RefParentCompanyId FROM dbo.RefEntityType  WHERE Code = 'Client'  
    
 ---------parameter validation --------------------    
 --IF (DATEDIFF(DAY,@InternalFromDate,(@InternalToDate+1))>30)    
 --BEGIN    
 -- RAISERROR ('This report can be extracted only for a period of 30 Days.',11,1) WITH SETERROR;    
 -- RETURN 50010;    
 --END    
    
 --IF (DATEDIFF(DAY,@InternalFromDate,(@InternalToDate))<0)    
 --BEGIN    
 -- RAISERROR ('To Date should be greater than From Date',11,1) WITH SETERROR;    
 -- RETURN 50010;    
 --END    
    
 IF(@ParentCompanyId IS NULL)      
 BEGIN        
  RAISERROR ('Please map the company',11,1) WITH SETERROR;          
  RETURN 50010;        
 END     
    
    
 ------getting the client details for date specified--------------    
 SELECT     
    his.CoreClientHistoryId,      
    his.TransactionId,      
    his.ParentCompany,      
    his.ProductAccountType,      
    his.ProductAccountNumber,    
    his.ApplicationNumber,    
    his.ProductAccountOpeningDateString AS [ProductAccountOpeningDate],    
    his.ProductAccountStatus,    
    his.ProductAccountStatusEffectiveDateString AS [ProductAccountStatusEffectiveDate],    
    his.ProductAccountStatusDescription,    
    his.ProductAccountReasonCodeDescription,    
    his.Remarks,    
    his.Channel,    
    his.IntermediaryCode,    
    his.IntroducerEmployeeCode,    
    his.Currency,    
    his.ProductApplicationDate,    
    his.ApplicationSignedDate,    
    his.RiskCommencementDateString AS [RiskCommencementDate],    
    his.FirstPremiumReceiptDateString AS [FirstPremiumReceiptDateString],    
    his.LoginDateString AS [LoginDate],    
    his.UnderwritingDateString AS [UnderwritingDate],    
    his.BranchReceiptDateString AS [BranchReceiptDate],    
    his.InsurancePurpose,    
    his.SumAssured,    
    his.GrossAnnualPremiumwithTax,    
    his.GrossAnnualPremiumwithoutTax,    
    his.ModalPremium,    
    his.PolicyTerm,    
    his.PayTerm,    
    his.PolicyEndDateString AS [PolicyEndDate],    
    his.NatureofCredit,    
    his.LendingArrangement,    
    his.DebtSubtype,    
    his.PolicyType,    
    his.AccountSegment,    
    his.CreateUpdateResponseStatusRefEntityIntegrationStatusId AS [ProcessingResponseStatus],     
    his.RejectionCount AS [UniqueRejectionCount],      
    his.RejectionCodes AS [UniqueRejectionCodes],      
    his.RejectionDescriptions AS [UniqueRejectionDescription],    
    his.CoreFileProcessLogId,  
 his.SanctionReferenceNumber,  
 his.RBIAssetClassification,  
 his.RBISMACategory,  
 his.LoanSecured   
 INTO #CoreClientHistory    
 FROM dbo.CoreClientHistory his    
 WHERE     
  his.AddedOn BETWEEN @InternalFromDate AND @InternalToDate     
  AND (@InternalProcessingStatus IS NULL OR his.CreateUpdateResponseStatusRefEntityIntegrationStatusId = @InternalProcessingStatus) AND his.RefParentCompanyId = @ParentCompanyId    
 ORDER BY his.CoreClientHistoryId    
    
 -----getting the rejection from rejectionhistory    
   SELECT hist.CoreClientHistoryId, rej.FieldName     
   INTO #rejectionCodes    
   FROM #CoreClientHistory hist    
   INNER JOIN dbo.LinkCoreClientHistoryRefRejectionCode link ON link.CoreClientHistoryId=hist.CoreClientHistoryId    
   INNER JOIN dbo.RefRejectionCode rej ON rej.RefRejectionCodeId=link.RefRejectionCodeId      
   WHERE link.IsFieldSaved=0    
    
    
   ---Rejected Feilds      
  SELECT      
   his.CoreClientHistoryId,      
   STUFF((SELECT ',' + tmp.FieldName       
    FROM #rejectionCodes tmp    
    WHERE tmp.CoreClientHistoryId=his.CoreClientHistoryId    
   FOR XML PATH('')),1,1,'') AS RejectedFields      
  INTO #RejectedFields      
  FROM #CoreClientHistory his    
    
    
  -----getting rejection of diiferent modules    
   SELECT      
   h.CoreClientHistoryId,      
   sm.Code AS [ModuleCode],      
   inte.Code AS [RejectionStatus],    
   moduleHis.ModuleApplicable,    
   moduleHis.RejectionCount,      
   moduleHis.RejectionCodes,      
   moduleHis.RejectionDescriptions      
  INTO #ModuleLevelRejection      
  FROM #CoreClientHistory h       
  INNER JOIN dbo.CoreClientModuleDetailHistory moduleHis ON h.CoreClientHistoryId=moduleHis.CoreClientHistoryId      
  INNER JOIN dbo.SecModule sm ON sm.SecModuleId = moduleHis.SecModuleId    
  INNER JOIN dbo.RefEntityIntegrationStatus inte ON   inte.RefEntityIntegrationStatusId  = moduleHis.ModuleStatusRefEnumValueId    
    
    
  ---getting the comma separated productAccountReasincode    
  SELECT      
   his.CoreClientHistoryId,      
   STUFF((SELECT ',' + tmp.ProductAccountStatusReasonCode       
    FROM dbo.CoreClientAccountStatusReasonCodeDetailHistory tmp    
    WHERE tmp.CoreClientHistoryId=his.CoreClientHistoryId    
   FOR XML PATH('')),1,1,'') AS [ProductAccountStatusReasonCode]      
  INTO #ClientAccountStatusReasonCodeDetailHistory    
  FROM #CoreClientHistory his    
    
   ---getting the comma separated productAccountsegment    
  SELECT      
   his.CoreClientHistoryId,      
   STUFF((SELECT ',' + tmp.ProductSegment       
    FROM dbo.CoreClientProductDetailHistory tmp    
    WHERE tmp.CoreClientHistoryId=his.CoreClientHistoryId    
   FOR XML PATH('')),1,1,'') AS [ProductSegment]      
  INTO #ClientProductDetailHistory    
  FROM #CoreClientHistory his    
    
   ---getting the comma separated producttags    
  SELECT      
   his.CoreClientHistoryId,      
   STUFF((SELECT ',' + tmp.Tag       
    FROM dbo.CoreClientTagDetailHistory tmp    
    WHERE tmp.CoreClientHistoryId=his.CoreClientHistoryId    
   FOR XML PATH('')),1,1,'') AS [Tag]    
  INTO #ClientTagDetailHistory    
  FROM #CoreClientHistory his    
    
    
 -----final output------------------    
 SELECT  DISTINCT    
   --his.CoreClientHistoryId,      
   his.TransactionId,      
   his.ParentCompany,      
   his.ProductAccountType,      
   his.ProductAccountNumber,    
   prot.ProductSegment,    
   his.ApplicationNumber,    
   rel.FirstHolderRelation,    
         rel.FirstHolderRecordIdentifier,      
         rel.FirstHolderSourceSystemName,      
         rel.FirstHolderSourceSystemCustomerCode,    
   his.[ProductAccountOpeningDate],    
   his.ProductAccountStatus,    
   his.[ProductAccountStatusEffectiveDate],    
   his.ProductAccountStatusDescription,    
   reasoncode.ProductAccountStatusReasonCode,    
   his.ProductAccountReasonCodeDescription,    
   his.Remarks,    
   loan.OldProductAccountNumber,    
   his.Channel,    
   his.IntermediaryCode,    
   his.IntroducerEmployeeCode,    
   loan.RelatedPartyCount,    
   his.Currency,    
   his.ProductApplicationDate,    
   his.ApplicationSignedDate,    
   loan.AsOfDate,    
   bankdtls.BankCode,    
   bankdtls.MICRCode,    
   bankdtls.BankName,    
   bankdtls.BankBranchName,    
   bankdtls.AccountNumber,    
   bankdtls.AccountType,    
   bankdtls.IFSCCode,    
   tags.Tag AS [Tags],    
   his.[RiskCommencementDate],    
   his.FirstPremiumReceiptDateString AS [FirstPremiumReceiptDateString],    
   his.[LoginDate],    
   his.[UnderwritingDate],    
   his.[BranchReceiptDate],    
   his.InsurancePurpose,    
   his.SumAssured,    
   his.GrossAnnualPremiumwithTax,    
   his.GrossAnnualPremiumwithoutTax,    
   his.ModalPremium,    
   his.PolicyTerm,    
   his.PayTerm,    
   loan.Repaymentfrequency AS [TransactionFrequency],    
   his.[PolicyEndDate],    
   loan.SanctionDate,    
   loan.DisbursementDate,    
   loan.SanctionedAmount,    
   his.NatureofCredit,    
   loan.RateofInterest,    
   his.LendingArrangement,    
   loan.TotalOutstandingAmount,    
   loan.AmountOverdue,    
   loan.DaysPastDue,    
   loan.SecurityCount,    
   loan.FinalEMIDate,    
   loan.TenureInMonths,    
   loan.EMIAmount,    
   loan.BorrowerDetails,    
   loan.SecurityDetails,    
   loan.IsDefaulted,    
   loan.[DefaultDate] AS [DateOfDefault],    
   loan.DefaultAmount,    
   loan.LastRepaymentAmount AS [AmountOfLastPayment],    
   loan.DateofLastRepaymentString AS [DateofLastRepayment],    
   loan.DateofFilingofSuitString AS [DateofFilingofSuit],    
   his.DebtSubtype,    
   loan.FundedType,    
   loan.CreditorBusinessUnit,    
   loan.InterestOutstanding,    
   loan.OtherChargesOutstanding,    
   loan.DrawingPower,    
   loan.CreditorRMEmail,    
   loan.DefaultRemarks,    
   module.ModuleApplicable,    
   his.PolicyType,    
   relmang.RMType,    
   relmang.RMCode,    
   commadd.PermanentCKYCAddressType,    
   commadd.PlotnoSurveynoHouseFlatno,    
   commadd.PermanentAddressCountry,    
   commadd.PermanentAddressPinCode,    
   commadd.PermanentAddressLine1,    
   commadd.PermanentAddressLine2,    
   commadd.PermanentAddressLine3,    
   commadd.PermanentAddressDistrict,    
   commadd.PermanentAddressCity,    
   commadd.PermanentAddressState,    
   commadd.PermanentAddressProof,    
   commadd.CorrespondenceAddressCountry,    
   commadd.CorrespondenceAddressPinCode,    
   commadd.CorrespondenceAddressLine1,    
   commadd.CorrespondenceAddressLine2,    
   commadd.CorrespondenceAddressLine3,    
   commadd.CorrespondenceAddressDistrict,    
   commadd.CorrespondenceAddressCity,    
   commadd.CorrespondenceAddressState,    
   commadd.CorrespondenceAddressProof,    
   commadd.PersonalMobileISD,    
   commadd.PersonalMobileNumber,    
   commadd.PersonalEmail,    
   his.AccountSegment,    
   statusproc.[Name] AS [ProcessingResponseStatus],     
   his.[UniqueRejectionCount],      
   his.[UniqueRejectionCodes],      
   his.[UniqueRejectionDescription],      
   field.RejectedFields,      
   ckyc.RejectionStatus AS [CKYCStatus],      
   ckyc.RejectionCount AS [CKYCRejectionCount],      
   ckyc.RejectionCodes AS CKYCRejectionCodes,      
   ckyc.RejectionDescriptions AS [CKYCRejectionDescription],      
   tm.RejectionStatus AS [TMStatus],      
   tm.RejectionCount AS [TMRejectionCount],      
   tm.RejectionCodes AS [TMRejectionCodes],      
   tm.RejectionDescriptions AS [TMRejectionDescription],      
   screening.RejectionStatus AS [ScreeningStatus],      
   screening.RejectionCount AS [ScreeningRejectionCount],      
   screening.RejectionCodes AS [ScreeningRejectionCodes],      
   screening.RejectionDescriptions AS [ScreeningRejectionDescription],      
   riskRating.RejectionStatus AS [RiskRatingStatus],      
   riskRating.RejectionCount AS [RiskRatingRejectionCount],      
   riskRating.RejectionCodes AS [RiskRatingRejectionCodes],      
   riskRating.RejectionDescriptions AS [RiskRatingRejectionDescription],      
   iu.RejectionStatus AS [IULStatus],      
   iu.RejectionCount AS [IULRejectionCount],      
   iu.RejectionCodes AS [IURejectionCodes],      
   iu.RejectionDescriptions AS [IURejectionDescription],      
   cersai.RejectionStatus AS [CersaiStatus],      
   cersai.RejectionCount AS [CersaiRejectionCount],      
   cersai.RejectionCodes AS CersaiRejectionCodes,      
   cersai.RejectionDescriptions AS [CersaiRejectionDescription],  
   his.SanctionReferenceNumber,  
   his.RBIAssetClassification,  
   his.RBISMACategory,  
   his.LoanSecured   
  FROM #CoreClientHistory his    
  LEFT JOIN dbo.CoreClientRelationHistory rel ON rel.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN #ClientProductDetailHistory prot ON prot.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN #ClientAccountStatusReasonCodeDetailHistory reasoncode ON reasoncode.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN #ClientTagDetailHistory tags ON tags.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN dbo.CoreClientBankDetailHistory bankdtls ON bankdtls.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN dbo.CoreClientRelationshipManagerHistory relmang ON relmang.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN dbo.CoreClientLoanDetailHistory loan ON loan.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN dbo.CoreClientProductCommunicationDetailsHistory commadd ON commadd.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN #RejectedFields field ON his.CoreClientHistoryId = field.CoreClientHistoryId    
  LEFT JOIN #ModuleLevelRejection module ON module.CoreClientHistoryId = his.CoreClientHistoryId    
  LEFT JOIN #ModuleLevelRejection ckyc ON ckyc.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'CKYC'      
  LEFT JOIN #ModuleLevelRejection tm ON tm.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'TM'      
  LEFT JOIN #ModuleLevelRejection screening ON screening.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'Screening'      
  LEFT JOIN #ModuleLevelRejection riskRating ON riskRating.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'RiskRating'      
  LEFT JOIN #ModuleLevelRejection iu ON iu.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'IUL'      
  LEFT JOIN #ModuleLevelRejection cersai ON cersai.CoreClientHistoryId = his.CoreClientHistoryId AND ckyc.ModuleCode = 'Cersai'    
  LEFT JOIN dbo.RefEntityIntegrationStatus statusproc ON statusproc.RefEntityIntegrationStatusId = his.[ProcessingResponseStatus]    
END    